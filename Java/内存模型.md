# 内存模型
## JMM（Java Memory Model）
java内存模型，是一种符合内存模型规范的，屏蔽了各种硬件和操作系统的访问差异的，保证了Java程序在各种平台下对内存的访问都能保证效果一致的机制及规范；

java多线程之间是通过共享内存进行通信，而多线程之间进行通信的共享内存又称为主内存，其中每个线程又维护一个自己的本地内存；

JMM主要是控制本地内存和主内存之间的数据交互；

所有的变量都存储在主内存，每个线程都有自己的工作内存（又称本地内存），保存了被线程操作的变量的主内存副本拷贝；

线程对变量的所有操作都必须在工作内存中进行，不能直接读写主内存中的变量；线程之间无法直接访问对方工作内存中的变量，线程间变量的传递需要通过主内存；

## JVM (Java Virtual Machine)

java虚拟机，java虚拟机运行时内存区域结构包括【计栈本堆区】：

- 计：PC寄存器（程序计数器）(Program Counter Register)
- 栈：Java虚拟机栈(Java Virtual Machine stacks)【栈由栈帧构成（对应被调用方法）】
    - 局部变量表（Local Variables）:存储方法中的局部变量（声明非静态变量和形参），编译器确定大小，运行时大小不会发生变化
    - 操作数栈（Operand Stack）：需要执行的指令
    - 执行当前方法所属类的运行时常量池引用
    - 方法返回地址（Return Address）
- 本：本地方法栈(Native Method Stacks)：为执行本地方法服务（Native Method）
- 堆：Java堆(Java Heap)：存储对象本身和数组（所有线程共享）
- 区：方法区（Method Area），内含运行时常量池（Run-Time Constant Pool）：线程共享区域，在方法区中存储了每个类的信息（类名，方法信息，字段信息），静态变量，常量以及编译后代码（方法区在1.8称为元空间，1.7称为永久代）

另外还有：所有线程共享的数据区域，每个线程独享的数据区域，运行的常量

发生OOM原因：（配置过小）
- 栈溢出：循环调用
- 堆溢出：对象实例过多，垃圾回收失败过多（占用98%资源，回收不到2%，则溢出）
- 方法区溢出：类过多
- 直接内存溢出（堆外内存）

常量池（方法区内）：
- Class常量池：静态常量池，除类，字段，方法和接口的描述信息外，还有编译期间生成的字面量和符号引用（加载时替换为直接引用）
- 运行时常量池(虚拟机规范定义)：类加载完毕后，将Class常量池中的符号引用转存到运行时常量池中并替换掉；1.7之后物理地址转移到堆中，但逻辑仍然为方法区
- 字符串常量池：

### JVM优化

- 开启JVM大页内存（页表寄存缓存器TLB），增加虚拟地址和物理地址映射，减少CPU的TLB miss（类似三级缓存提前加载，不用去内存中寻找）：-XX:LargePageSizeInBytes=10m 【1.5之前需要加XX:+UseLargePages】
- 软引用和弱引用提升JVM内存性能:
    - 【强引用】只要引用存在，垃圾回收器永远不会工作；
    - 【软引用】非必须引用，内存溢出之前进行回收
    - 【弱引用】用在回调函数中防止内存泄露，第二次垃圾回收就回收【是否被垃圾回收期标记为即将回收的垃圾】
    - 【虚引用】垃圾回收时回收，无法通过引用取到对象值

注：新生代中Eden区和Survior去区的大小比例为：8：1：1，老年代是新生代大小2倍；

### JVM内存配置参数

|-配置-|-含义-|
|-|-|
|-Xss1024k|栈内存1024K，设置线程栈占用内存大小|
|-Xms512m| 堆内存初始值512m，如果未设置，初始值为老年代和年轻代分配内存之和|
|-Xmx1g| 堆内存最大值1g，默认值依赖于运行时系统配置|
|-Xmn512m| 设置新生代的初始值和最大值，默认值为堆内存的1/4（指已分配的堆内存的1/4)|
|-XX:NewSize=512m | 设置新生代初始值512m |
|-XX:MaxNewSize=512m | 新生代最大值512m|
|-XX:NewRatio=8 | 默认值2，设置老年代和新生代的比例，老年代堆内存占8，年轻代占1 |
|-XX:SurvivorRatio=8 | 默认值8，设置新生代和存活区的比例，Eden:S0:S1 = 8:1:1|
|-XX:MinHeapFreeRatio=40 | 默认40，当GC后发现空闲堆内存占整个预估上限值的40%，则增大上限值|
|-XX:MaxHeapFreeRatio=70 | 默认值70，当GC后发现空闲堆内存占整个预估上限值的70
%时，则收缩上限值 |
| -XX:MetaspaceSize=128m | 默认值依赖平台；初始元空间大小，达到该值就会触发垃圾收集进行类型卸载，同时GC对该值进行调整；如果释放了大量空间，就适当降低该值；如果释放了很少的空间，在不超过MaxMetaspaceSize时，适当提高该值；
| -XX:MaxMetaspaceSize=256m | 设置元空间最大值，默认无上限|


